"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))(function(n,a){function o(e){try{l(i.next(e))}catch(e){a(e)}}function s(e){try{l(i.throw(e))}catch(e){a(e)}}function l(e){e.done?n(e.value):new r(function(t){t(e.value)}).then(o,s)}l((i=i.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){function r(e){return function(t){return i([e,t])}}function i(r){if(n)throw new TypeError("Generator is already executing.");for(;l;)try{if(n=1,a&&(o=2&r[0]?a.return:r[0]?a.throw||((o=a.return)&&o.call(a),0):a.next)&&!(o=o.call(a,r[1])).done)return o;switch(a=0,o&&(r=[2&r[0],o.value]),r[0]){case 0:case 1:o=r;break;case 4:return l.label++,{value:r[1],done:!1};case 5:l.label++,a=r[1],r=[0];continue;case 7:r=l.ops.pop(),l.trys.pop();continue;default:if(o=l.trys,!(o=o.length>0&&o[o.length-1])&&(6===r[0]||2===r[0])){l=0;continue}if(3===r[0]&&(!o||r[1]>o[0]&&r[1]<o[3])){l.label=r[1];break}if(6===r[0]&&l.label<o[1]){l.label=o[1],o=r;break}if(o&&l.label<o[2]){l.label=o[2],l.ops.push(r);break}o[2]&&l.ops.pop(),l.trys.pop();continue}r=t.call(e,l)}catch(e){r=[6,e],a=0}finally{n=o=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}var n,a,o,s,l={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s},__extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}(),powerbi;!function(e){var t;!function(e){var t;!function(e){var t;!function(e){e.NotIn="NotIn",e.SelectAll="All",e.logicalOperatorDictionary={Or:1,And:0};var t;!function(e){e.InvalidDataType="InvalidDataType",e.FieldNotFound="FieldNotFound",e.FilterConditionNotFound="FilterConditionNotFound",e.FilterValidationErrors="FilterValidationErrors",e.LogicalConditionNotFound="LogicalConditionNotFound",e.BasicFilterSerializationError="BasicFilterSerializationError",e.TupleFilterSerializationError="TupleFilterSerializationError",e.AdvancedFilterSerializationError="AdvancedFilterSerializationError",e.InvalidFilterType="InvalidFilterType",e.InvalidFilterCondition="InvalidFilterCondition",e.FilterNotFound="FilterNotFound",e.BasicFilterOperatorNotFound="BasicFilterOperatorNotFound",e.InvalidReportData="InvalidReportData",e.InvalidPageData="InvalidPageData"}(t=e.ErrorCodes||(e.ErrorCodes={}));var r;!function(e){e.InvalidFilterMessage="Filter is not valid, validation errors: ",e.InvalidTarget="Could not serialize json filter target to SQ expression.",e.InvalidCondition="Advanced filter requires a filter condition (None | LessThan | LessThanOrEqual | GreaterThan | GreaterThanOrEqual | Contains | DoesNotContain | StartsWith | DoesNotStartWith | Is | IsNot | IsBlank | IsNotBlank).",e.InvalidDataTypeMessage="The data type of the value {0} is not supported. Only string, number and boolean are supported.",e.FilterSerializationError="Could not serialize filter.",e.InvalidFilterTypeMessage="Not supported filter type - can't serialize to json syntax.",e.SemanticFilterInvalidCondition="Filter with invalid condition - can't serialize to json syntax.",e.FilterNotFoundMessage="Invoked filter serialization function with no filter.",e.FieldNotFoundMessage="Invoked filter serialization function on a table that has no column/measure/hierarchy.",e.BasicFilterOperatorNotFoundMessage="Basic filter requires an operator (In | Not).",e.FilterValuesNotFound=" Could not retrieve filter values.",e.InvalidReportDataMessage="Could not find the report.",e.InvalidPageDataMessage="Could not find the active page.",e.DataPointSerializationError="Could not serialize a data point.",e.TupleFilterSerializationError="Could not serialize Tuple filter."}(r=e.ErrorMessages||(e.ErrorMessages={}))}(t=e.constants||(e.constants={}))}(t=e.jsonFilter||(e.jsonFilter={}))}(t=e.explore||(e.explore={}))}(powerbi||(powerbi={}));var powerbi;!function(e){var t;!function(t){var r;!function(i){function n(e){return"name"in e}function a(e){return"visualName"in e&&"pageName"in e}function o(t,r,i,n){return __awaiter(this,void 0,e.Promise,function(){var e,a,o;return __generator(this,function(s){switch(s.label){case 0:return[4,r.require({javascript:"powerbi-models"})];case 1:return e=s.sent(),[4,n.get("@powerbi/JsonContracts/json-contracts.module#JsonContractsModule","jsonTargetParserService")];case 2:return a=s.sent(),[4,n.get("@powerbi/JsonContracts/json-contracts.module#JsonContractsModule","filterContainerProvider")];case 3:return o=s.sent(),[2,new v(t,e,i,a,o)]}})})}var s=r.constants,l=t.contracts.FilterType,u=e.data.SQExprBuilder,p=e.data.SemanticFilter,c=jsCommon.Trace,d=jsCommon.Utility;i.instanceOfIPageLevel=n,i.instanceOfIVisualLevel=a,i.createJSONFilterParserService=o;var v=function(){function t(e,t,r,n,a){this.promiseFactory=e,this.PowerBIModels=t,this.telemetryService=r,this.jsonTargetParserService=n,this.filterContainerProvider=a,this.fieldVisitor=new i.JsonFilterBuilder.SemanticFilterFieldVisitor}return t.prototype.tryCreateFilterContainer=function(e,t,r){try{return this.constructFilterContainer(e,t,r)}catch(e){return f.traceError(e),null}},t.prototype.tryConvertJsonFilterArrayToFilterDataArray=function(e,t){try{return this.convertJsonFilterArrayToFilterDataArray(e,t)}catch(e){f.traceError(e)}return null},t.prototype.tryGetFilters=function(e,t){var r=this,n=[];if(!e.filters||0===e.filters.length)return this.promiseFactory.resolve(n);try{n=e.filters.map(function(e){return i.JsonFilterBuilder.fromSemanticFilter(e,t,e.filter,r.PowerBIModels,r.telemetryService)})}catch(e){return f.traceError(e),void 0!==e.message?this.promiseFactory.reject({message:e.message}):this.promiseFactory.reject({message:s.ErrorMessages.FilterSerializationError})}return this.promiseFactory.resolve(n)},t.prototype.tryGetSelectedDataPoints=function(e,t,r,i,n){var a=this;if(!i||!i.config||!i.config.singleVisual)return this.promiseFactory.reject({message:s.ErrorMessages.DataPointSerializationError});var o,l=i.config.singleVisual,u=this.promiseFactory.defer();return this.tryGetFilters(i,t).then(function(p){try{o={report:a.getReportInfo(e),page:a.getActivePageInfo(e),visual:a.getVisualInfo(i.name,n,l.visualType),dataPoints:a.getDataPoints(r,t),regions:null,filters:p},u.resolve(o)}catch(e){f.traceError(e),void 0!==e.message?u.reject({message:e.message}):u.reject({message:s.ErrorMessages.DataPointSerializationError})}}).catch(function(e){u.reject(e)}),u.promise},t.prototype.getValues=function(e,t){var r=this,i=[];return e?_.map(e,function(e){return{target:r.jsonTargetParserService.getTarget(e.expr,t),value:e.value,formattedValue:e.formattedValue}}):i},t.prototype.getDataPoints=function(t,r){var i=[];if(_.isEmpty(t))return i;for(var n=0,a=t;n<a.length;n++){var o=a[n],s={identity:[],values:this.getValues(o.values,r)},l=o.selector.data;if(l)for(var u=0,p=l;u<p.length;u++){var c=p[u];if(c.expr){var d=c,v=e.data.SQExprConverter.getAllComparands(d);if(!v)return i;for(var f=0,F=v;f<F.length;f++){var y=F[f],g=y.expr.accept(this.fieldVisitor);s.identity.push({target:g,equals:y.value})}}}i.push(s)}return i},t.prototype.getReportInfo=function(e){return e&&null!=e.activeSectionIndex||d.throwException(f.invalidReportData()),{id:e.report.objectId,displayName:e.report.displayName}},t.prototype.getActivePageInfo=function(e){e&&null!=e.activeSectionIndex||d.throwException(f.invalidPageData());var t=e.sections[e.activeSectionIndex];return{name:t.name,displayName:t.displayName}},t.prototype.getVisualInfo=function(e,t,r){var i={name:e,type:r};return t&&(i.title=t),i},t.prototype.constructFilterContainer=function(e,t,r){var i,n=this.validateFilter(r);return n&&d.throwException(f.filterValidationErrors(n)),i=this.filterContainerProvider.tryBuildFilterContainer(e,t,r),this.updateFilterDisplaySettings(i,r.displaySettings),i},t.prototype.updateFilterDisplaySettings=function(e,t){e&&t&&(e.isLockedInViewMode=t.isLockedInViewMode,e.isHiddenInViewMode=t.isHiddenInViewMode,e.displayName=t.displayName)},t.prototype.getTupleElementTargetExpressions=function(e,t){var r=this.jsonTargetParserService.getFieldExpr(e,t);r||d.throwException(f.fieldNotFound(e));var i=this.getFieldExprsForKeys(e,t);return i?i:[r]},t.prototype.getTupleElementTargetKeyExpressions=function(e,t){var r=this.getFieldExprsForKeys(e,t);return r?r:[]},t.prototype.getTupleElementTargetNonKeyExpression=function(e,t){var r=this.jsonTargetParserService.getFieldExpr(e,t);return r||d.throwException(f.fieldNotFound(e)),r},t.prototype.getTupleTargetExpressions=function(e,t){for(var r=[],i=0,n=e;i<n.length;i++){var a=n[i];r=r.concat(this.getTupleElementTargetExpressions(a,t))}return r},t.prototype.getTupleElementValueExpressions=function(e){var t=[];if(e.keyValues)for(var r=0,i=e.keyValues;r<i.length;r++){var n=i[r];t.push(this.buildSQConstantExpr(n))}else t.push(this.buildSQConstantExpr(e.value));return t},t.prototype.getTupleElementKeyValueExpressions=function(e){var t=[];if(e.keyValues)for(var r=0,i=e.keyValues;r<i.length;r++){var n=i[r];t.push(this.buildSQConstantExpr(n))}return t},t.prototype.getTupleElementNonKeyValueExpression=function(e){return this.buildSQConstantExpr(e.value)},t.prototype.getTupleValueExpressions=function(e){for(var t=[],r=0,i=e;r<i.length;r++){var n=i[r];t=t.concat(this.getTupleElementValueExpressions(n))}return t},t.prototype.convertJsonFilterArrayToFilterDataArray=function(e,t){var r=this;return _.isEmpty(e)?[]:_.map(e,function(e){return r.convertJsonFilterToFilterData(e,t)})},t.prototype.convertJsonFilterToFilterData=function(e,t){var r={filter:null,type:null,filterExpressionMetadata:null,displayName:null};if(e)if(e.filterType===this.PowerBIModels.FilterType.Tuple)r.type=l.Tuple,r.filter=this.convertJsonTupleFilterToSemanticFilter(e,t),r.filterExpressionMetadata=this.extractFilterExpressionMetadataFromJsonTupleFilter(e,t);else{var i={filters:[{name:"Filter"}]},n=this.constructFilterContainer(i,t,e);r.filter=n&&n.filter}return r},t.prototype.convertJsonTupleFilterToSemanticFilter=function(e,t){for(var r=this.getTupleTargetExpressions(e.target,t),i=[],n=0,a=e.values;n<a.length;n++){var o=a[n];i.push(this.getTupleValueExpressions(o))}var s=u.inValues(r,i);return p.fromSQExpr(s)},t.prototype.extractFilterExpressionMetadataFromJsonTupleFilter=function(e,t){var r={expressions:[],cachedValueItems:[]};return this.populateFilterExpressionMetadata(r,e,t),r},t.prototype.populateFilterExpressionMetadata=function(e,t,r){var i=this;if(_.find(t.target,function(e){return!_.isEmpty(i.getTupleElementTargetKeyExpressions(e,r))})){var n=_.map(t.target,function(e){return i.getTupleElementTargetKeyExpressions(e,r)});e.expressions=_.map(t.target,function(e){return i.getTupleElementTargetNonKeyExpression(e,r)});for(var a=0,o=t.values;a<o.length;a++){for(var s=o[a],l={identities:[],valueMap:{}},u=0;u<t.target.length;u++){var p=s[u];_.isString(p.value)?l.valueMap[u]=p.value:d.throwException(f.invalidDataType(p.value));var c=void 0;if(_.isEmpty(n[u])){var v=this.getTupleElementNonKeyValueExpression(p),F=e.expressions[u];c=this.makeIdentity([F],[v])}else{var y=this.getTupleElementKeyValueExpressions(p),g=n[u];c=this.makeIdentity(g,y)}l.identities.push(c)}e.cachedValueItems.push(l)}}},t.prototype.makeIdentity=function(t,r){for(var i,n=0;n<t.length;n++){var a=u.equal(t[n],r[n]);i=i?u.and(i,a):a}return e.data.createDataViewScopeIdentity(i)},t.prototype.getFieldExprsForKeys=function(e,t){var r=this;return e&&e.keys?_.map(e.keys,function(i){return r.jsonTargetParserService.getFieldExpr(e,t,i)}):null},t.prototype.buildSQConstantExpr=function(t){var r;if(_.isString(t))if(null!=jsCommon.DateExtensions.parseIsoDateFast(t.substr(0,26))){var i=jsCommon.DateExtensions.parseIsoDateFast(t.substr(0,26));r=u.dateTime(i)}else r=u.text(t);else _.isBoolean(t)?r=u.boolean(t):_.isNumber(t)?r=e.Double.isInteger(t)?u.integer(t):u.double(t):null===t?r=u.nullConstant():d.throwException(f.invalidDataType(t));return r},t.prototype.validateFilter=function(e){return this.PowerBIModels.validateFilter(e)},t}(),f=function(){function e(){}return e.traceError=function(e){c.error("Throwing exception: "+JSON.stringify(e),null==e.Stack)},e.fieldNotFound=function(e){var t=e?"Target table: "+e.table:"";return{name:s.ErrorCodes.FieldNotFound,message:s.ErrorMessages.InvalidTarget+t}},e.filterValidationErrors=function(e){var t=e.map(function(e){return e.message}).join(", ");return{name:s.ErrorCodes.FilterValidationErrors,message:s.ErrorMessages.InvalidFilterMessage+t}},e.invalidDataType=function(e){return{name:s.ErrorCodes.InvalidDataType,message:jsCommon.StringExtensions.format(s.ErrorMessages.InvalidDataTypeMessage,e)}},e.filterConditionNotFound=function(){return{name:s.ErrorCodes.FilterConditionNotFound,message:s.ErrorMessages.InvalidCondition}},e.basicFilterSerializationError=function(e){return{name:s.ErrorCodes.BasicFilterSerializationError,message:s.ErrorMessages.FilterSerializationError+e}},e.advancedFilterSerializationError=function(){return{name:s.ErrorCodes.AdvancedFilterSerializationError,message:s.ErrorMessages.FilterSerializationError}},e.tupleFilterSerializationError=function(e){return{name:s.ErrorCodes.BasicFilterSerializationError,message:s.ErrorMessages.TupleFilterSerializationError+e}},e.invalidFilterType=function(){return{name:s.ErrorCodes.InvalidFilterType,message:s.ErrorMessages.InvalidFilterTypeMessage}},e.invalidFilterCondition=function(){return{name:s.ErrorCodes.InvalidFilterCondition,message:s.ErrorMessages.SemanticFilterInvalidCondition}},e.filterNotFound=function(){return{name:s.ErrorCodes.FilterNotFound,message:s.ErrorMessages.FilterNotFoundMessage}},e.fieldExpressionNotFound=function(){return{name:s.ErrorCodes.FieldNotFound,message:s.ErrorMessages.FieldNotFoundMessage}},e.basicFilterOperatorNotFound=function(){return{name:s.ErrorCodes.BasicFilterOperatorNotFound,message:s.ErrorMessages.BasicFilterOperatorNotFoundMessage}},e.invalidReportData=function(){return{name:s.ErrorCodes.InvalidReportData,message:s.ErrorMessages.InvalidReportDataMessage}},e.invalidPageData=function(){return{name:s.ErrorCodes.InvalidPageData,message:s.ErrorMessages.InvalidPageDataMessage}},e}();i.JsonFilterParserErrors=f}(r=t.jsonFilter||(t.jsonFilter={}))}(t=e.explore||(e.explore={}))}(powerbi||(powerbi={}));var powerbi;!function(e){var t;!function(t){var r;!function(r){var i,n=jsCommon.ArrayExtensions,a=e.explore.viewModels.FilterCardConverter,o=e.explore.jsonFilter.constants,s=jsCommon.Utility,l=e.data.SQExpr,u=e.data.SQExprUtils,p=e.data.SQConstantExpr,c=e.data.DataViewObjectDefinitions,d=e.data.RelativeFilterType,v=e.data.ScopeIdentityExtractor.ScopeIdKeysAndValuesExtractorImpl;!function(i){function n(i,n,a,l,p){var c;if(a&&(!a.conditions()||_.isEmpty(a.conditions())||a.conditions().length>1)&&s.throwException(r.JsonFilterParserErrors.invalidFilterCondition()),u(i))if(i.type===t.contracts.FilterType.TopN)c=h.serializeFilter(a,n,l,i);else if(i.type===t.contracts.FilterType.RelativeDate)c=E.serializeFilter(a,n,l,i);else if(i.type===t.contracts.FilterType.Exclude||i.type===t.contracts.FilterType.Include)c=m.serializeFilter(a,n,l,i);else if(i.type===t.contracts.FilterType.Tuple)c=x.serializeFilter(a,n,l,i);else{var d=i.expression,v=void 0;if(a){var f=a.conditions()[0];v=S.getAdvancedFilterExpression(f)}var F=i.type;null==F&&(d||s.throwException(r.JsonFilterParserErrors.fieldExpressionNotFound()),F=t.FilterUtils.getDefaultFilterType(d,n,i.howCreated,v?v.field:null)),v&&F===t.contracts.FilterType.Advanced?c=S.serializeFilter(v,n,l,i):(d||s.throwException(r.JsonFilterParserErrors.fieldExpressionNotFound()),c=T.serializeFilter(a,i,n,l,i))}else{p.logEvent(e.telemetry.JSONFilterUnsupportedFilterType,t.contracts.FilterType[i.type]);c=new l.NotSupportedFilter(null,o.ErrorMessages.InvalidFilterTypeMessage,t.contracts.FilterType[i.type]).toJSON()}return c}function u(e){return e.type===t.contracts.FilterType.TopN||e.type===t.contracts.FilterType.Exclude||e.type===t.contracts.FilterType.Include||e.type===t.contracts.FilterType.RelativeDate||e.type===t.contracts.FilterType.Categorical||e.type===t.contracts.FilterType.Visual||e.type===t.contracts.FilterType.Advanced||e.type===t.contracts.FilterType.Tuple||!e.type}function f(e,t,r){var i=e.accept(t);return e.hasGroupOnKeys(r)&&(i.keys=y(e,t,r)),i}function y(e,t,r){var i=e.getKeyColumns(r),n=[];return i&&(n=i.map(function(e){return e.accept(t).column})),n}function g(e,t){if(e&&t){var r={};void 0!==t.isLockedInViewMode&&(r.isLockedInViewMode=t.isLockedInViewMode),void 0!==t.isHiddenInViewMode&&(r.isHiddenInViewMode=t.isHiddenInViewMode),void 0!==t.displayName&&(r.displayName=t.displayName),_.isEmpty(r)||(e.displaySettings=r)}}i.fromSemanticFilter=n,i.getTarget=f;var h;!function(t){function i(t,i,n,a){t||s.throwException(r.JsonFilterParserErrors.filterNotFound());var o=new w,l=e.data.TopNFilterPattern.extractParametersFromFilter(t),u=new n.TopNFilter(f(l.fieldBeingFiltered,o,i),l.isTop?"Top":"Bottom",l.itemCount,f(l.orderByField,o,i));return g(u,a),u.toJSON()}t.serializeFilter=i}(h||(h={}));var m;!function(e){function t(e,t,i,n){e&&!_.isEmpty(e.conditions())||s.throwException(r.JsonFilterParserErrors.filterNotFound());var a=new F,o=e.conditions()[0].accept(a),l=o[0].fieldExpr,u=o[0].isNot,p=new i.IncludeExcludeFilter(f(l,new w,t),u||!1,T.getValuesFromSQExpr(l,t,e).displayedValues);return g(p,n),p.toJSON()}e.serializeFilter=t}(m||(m={}));var E;!function(t){function i(t,i,o,l){t||s.throwException(r.JsonFilterParserErrors.filterNotFound());var u=e.data.RelativeDateFilterPattern.extractParametersFromSemanticFilter(t,d.Date),p=u.options,c=new w,v=new o.RelativeDateFilter(f(u.field,c,i),n(u.options,o),p.duration,a(u.options,o),(!!p.includeToday));return g(v,l),v.toJSON()}function n(t,r){if(!t)return null;var i=t.relativeQualifier;return i===e.data.RelativeDateQualifier.Current?r.RelativeDateOperators.InThis:i===e.data.RelativeDateQualifier.Next?r.RelativeDateOperators.InNext:i===e.data.RelativeDateQualifier.Last?r.RelativeDateOperators.InLast:void 0}function a(t,r){if(!t)return null;var i=t.relativeUnit;return i===e.data.RelativeDateUnit.CalendarMonth?r.RelativeDateFilterTimeUnit.CalendarMonths:i===e.data.RelativeDateUnit.CalendarWeek?r.RelativeDateFilterTimeUnit.CalendarWeeks:i===e.data.RelativeDateUnit.CalendarYear?r.RelativeDateFilterTimeUnit.CalendarYears:i===e.data.RelativeDateUnit.Day?r.RelativeDateFilterTimeUnit.Days:i===e.data.RelativeDateUnit.Month?r.RelativeDateFilterTimeUnit.Months:i===e.data.RelativeDateUnit.Week?r.RelativeDateFilterTimeUnit.Weeks:i===e.data.RelativeDateUnit.Year?r.RelativeDateFilterTimeUnit.Years:void 0}t.serializeFilter=i}(E||(E={}));var T;!function(t){function i(e,i,n,a,l){var u,p=new w,c=f(i.expression,p,n),d=e?t.getOperator(n,e,i.expression):o.SelectAll,v=t.getValuesFromSQExpr(i.expression,n,e,i.cachedValueItems);return u=v.keyValues&&v.keyValues.length>0?new a.BasicFilterWithKeys(c,d,v.displayedValues,v.keyValues):new a.BasicFilter(c,d,v.displayedValues),u||s.throwException(r.JsonFilterParserErrors.basicFilterSerializationError()),g(u,l),u.requireSingleSelection=t.requireSingleSelection(l),u.toJSON()}function n(e){if(!e.objects)return!1;var t=c.getValue(e.objects,{objectName:"general",propertyName:"requireSingleSelect"},void 0);return!(!t||!t.value)&&p.getBooleanValue(t)}function a(t,i,n,a){var l={displayedValues:[],keyValues:[]};if(!n)return l;var p,c=u(i,n,t);c&&(p=_.isEmpty(c.scopeIds)?[]:c.scopeIds[0]),_.isEmpty(p)&&s.throwException(r.JsonFilterParserErrors.basicFilterSerializationError(o.ErrorMessages.FilterValuesNotFound));for(var f=0,F=p;f<F.length;f++){var y=F[f];if(t.hasGroupOnKeys(i)){var g=e.data.SQExprConverter.getAllComparands(y),h=g.map(function(e){return d(e.value)});l.keyValues.push(h),_.isEmpty(a)||a.length!==p.length?s.throwException(r.JsonFilterParserErrors.basicFilterSerializationError(o.ErrorMessages.FilterValuesNotFound)):l.displayedValues=a.map(function(e){return v(e)})}else{var m=e.data.SQExprConverter.getFirstComparandValue(y);l.displayedValues.push(d(m))}}return l}function l(e,t,i){var n=u(e,t,i);return n?n.isNot?"NotIn":"In":void s.throwException(r.JsonFilterParserErrors.basicFilterOperatorNotFound())}function u(t,i,n){var a=n.getKeyColumns(t);return a||s.throwException(r.JsonFilterParserErrors.fieldExpressionNotFound()),e.data.SQExprConverter.asScopeIdsContainer(i,[a])}function d(e){return _.isDate(e)?e.toISOString():e}function v(e){var t=e;return null===e?null:"string"==typeof e?e:t&&t.displayName?t.displayName:void s.throwException(r.JsonFilterParserErrors.invalidDataType("Unrecognized type of value: "+e))}t.serializeFilter=i,t.requireSingleSelection=n,t.getValuesFromSQExpr=a,t.getOperator=l}(T||(T={}));var x;!function(i){function n(i,n,a,o){if(!i)return null;var u=null,p=null,c=i.where(),d=c&&c[0]&&c[0].condition;if(!(e.data.SQExpr.isIn(d)&&d.values&&d.args&&d.args.length>0))return null;u=d.args,p=d.values;var f,F,y=o.filterExpressionMetadata,h=y&&!_.isEmpty(y.cachedValueItems);if(h){var m=p[0];F=t.FilterUtils.findIdentityMapInFilterCache(u,m,y)}if(h&&F){for(var E=[],T=[],x=0;x<F.identities.length;x++){var S=F.identities[x],w=new v;S.expr.accept(w);var C=y.expressions[x],N=C.getTargetEntity().entity,I=C.ref;if(1===w.keys.length&&I===w.keys[0].ref){var b={table:N,column:I};T.push(x),E.push(b)}else{for(var b={table:N,column:I,keys:[]},D=0,P=w.keys;D<P.length;D++){var M=P[D],V=M,J=(V.getTargetEntity().entity,V.ref);b.keys.push(J),T.push(x)}E.push(b)}}for(var O=[],z=0,j=p;z<j.length;z++){for(var k=j[z],A=t.FilterUtils.findIdentityMapInFilterCache(u,k,y),R=[],x=0;x<A.identities.length;x++){var U=A.valueMap[x],B={value:U};R.push(B)}for(var Q=0;Q<k.length;Q++){var L=k[Q].value,q=T[Q];E[q].keys&&(R[q].keyValues||(R[q].keyValues=[]),R[q].keyValues.push(L))}O.push(R)}f=new a.TupleFilter(E,"In",O)}else{var K=_.map(u,function(e){var t=e.getTargetColumnRef(n);return{table:t.getTargetEntity().entity,column:t.ref}}),G=_.map(p,function(e){return _.map(e,function(e){if(l.isConstant(e)){return{value:e.value}}s.throwException(r.JsonFilterParserErrors.tupleFilterSerializationError())})});f=new a.TupleFilter(K,"In",G)}return f||s.throwException(r.JsonFilterParserErrors.tupleFilterSerializationError()),g(f,o),f.toJSON()}i.serializeFilter=n}(x||(x={}));var S;!function(t){function i(e,i,n,a){var o=new w,l=e.field.accept(o),u=t.getAdvancedFilterLogicalOperator(e.logicalOperator),p=e.conditions.map(function(e){return t.getAdvancedFilterCondition(e)}),c=new n.AdvancedFilter(l,u,p);return c||s.throwException(r.JsonFilterParserErrors.advancedFilterSerializationError()),g(c,a),c.toJSON()}function n(e){return a.createAdvFilter(e)}function o(e){switch(e){case 0:return"And";case 1:return"Or";case 2:return"And"}}function l(t){!e.data.OperatorHelper.getValueRequired(t.operator)||t.value&&t.value.hasValue||s.throwException(r.JsonFilterParserErrors.filterConditionNotFound());var i;9===t.operator?i="Is":10===t.operator?i="IsNot":3===t.operator?i="GreaterThan":4===t.operator?i="GreaterThanOrEqual":1===t.operator?i="LessThan":2===t.operator?i="LessThanOrEqual":5===t.operator?i="Contains":6===t.operator?i="DoesNotContain":7===t.operator?i="StartsWith":8===t.operator?i="DoesNotStartWith":11===t.operator?i="IsBlank":12===t.operator?i="IsNotBlank":s.throwException(r.JsonFilterParserErrors.filterConditionNotFound());var n=t.value;return{operator:i,value:t.value.isDate?n.value.toISOString():n.value}}t.serializeFilter=i,t.getAdvancedFilterExpression=n,t.getAdvancedFilterLogicalOperator=o,t.getAdvancedFilterCondition=l}(S||(S={}));var w=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return __extends(r,t),r.prototype.visitEntity=function(e){return{table:e.entity,column:null}},r.prototype.visitHierarchy=function(e){var t=e.arg.accept(this);return t?{table:t.table,hierarchy:e.hierarchy,hierarchyLevel:null}:null},r.prototype.visitAggr=function(t){var r=t.arg.accept(this);if(!r)return null;var i=r;return i.aggregationFunction=e.data.aggregateFunctionName(t.func),i},r.prototype.visitColumnRef=function(e){var t=e.source.accept(this);return t?{table:t.table,column:e.ref}:null},r.prototype.visitMeasureRef=function(e){var t=e.source.accept(this);return t?{table:t.table,measure:e.ref}:null},r.prototype.visitHierarchyLevel=function(e){var t=e.arg.accept(this);return t?{table:t.table,hierarchy:t.hierarchy,hierarchyLevel:e.level}:null},r}(e.data.DefaultSQExprVisitor);i.SemanticFilterFieldVisitor=w}(i=r.JsonFilterBuilder||(r.JsonFilterBuilder={}));var f;!function(e){function t(e,t){for(var r=[],i=function(i,n){var a=_.map(e.values,function(e){return e[i]});r.push({fieldExpr:e.args[i],isNot:t,values:u.concatUnique([],a)})},n=0,a=e.args.length;n<a;n++)i(n,a);return r}function r(e,t){for(var r,i=n.copy(e),a=0,o=t;a<o.length;a++){r=o[a];var s=_.findIndex(i,function(e){return l.equals(e.fieldExpr,r.fieldExpr)&&e.isNot===r.isNot});if(s!==-1){var p=i[s];p.values=u.concatUnique(p.values,r.values)}else i.push(r)}return i}e.fromInExpr=t,e.merge=r}(f||(f={}));var F=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.visitIn=function(e){return f.fromInExpr(e)},t.prototype.visitNot=function(t){return t&&t.arg&&10===t.arg.kind?f.fromInExpr(t.arg,!0):e.prototype.visitNot.call(this,t,void 0)},t.prototype.visitAnd=function(e){var t=e.left.accept(this),r=e.right.accept(this);if(t&&r)return f.merge(t,r)},t}(e.data.DefaultSQExprVisitor)}(r=t.jsonFilter||(t.jsonFilter={}))}(t=e.explore||(e.explore={}))}(powerbi||(powerbi={})),define("JSONFilter/services/jsonFilterParser",["require","exports"],function(e,t){function r(e,t,r,i){return __awaiter(this,void 0,powerbi.Promise,function(){return __generator(this,function(n){return[2,new p(e,t,r,i)]})})}Object.defineProperty(t,"__esModule",{value:!0});var i=powerbi,n=i.explore,a=powerbi.explore.viewModels.FilterCardConverter,o=i.data.SemanticFilter,s=n.jsonFilter,l=powerbi.PbiPromise,u=powerbi.data.RelativeFilterType;t.create=r;var p=function(){function e(e,t,r,i){this.promiseFactory=e,this.moduleLoader=t,this.telemetryService=r,this.lazyProviderModern=i}return e.prototype.tryCreateSemanticFilter=function(e,t,r){return __awaiter(this,void 0,powerbi.Promise,function(){var i,n,a;return __generator(this,function(o){switch(o.label){case 0:return i={filters:[{name:e}]},[4,this.getParser()];case 1:return n=o.sent(),a=n.tryCreateFilterContainer(i,t,r),a?[2,a.filter]:[2]}})})},e.prototype.tryConvertJsonFilterArrayToFilterDataArray=function(e,t){return __awaiter(this,void 0,powerbi.Promise,function(){var r,i;return __generator(this,function(n){switch(n.label){case 0:return[4,this.getParser()];case 1:return r=n.sent(),i=r.tryConvertJsonFilterArrayToFilterDataArray(e,t),[2,i]}})})},e.prototype.tryCreateJSONFilter=function(e,t,r){return __awaiter(this,void 0,powerbi.Promise,function(){var s,l,p,c,d,v,f,F,y,g,h,m,E;return __generator(this,function(T){switch(T.label){case 0:return[4,this.getParser()];case 1:if(s=T.sent(),l=o.unmerge(e),_.isEmpty(l))return[2,[]];for(p=[],c=0,d=l;c<d.length;c++){if(v=d[c],f={name:"filter",filter:v},F=!1,F||(y=i.data.TopNFilterPattern.extractParametersFromFilter(v),y&&(f.type=n.contracts.FilterType.TopN,F=!0)),F||(g=i.data.RelativeDateFilterPattern.extractParametersFromSemanticFilter(v,u.Date),g&&(f.type=n.contracts.FilterType.RelativeDate,F=!0)),F||(h=i.data.TupleFilterPattern.extractParametersFromFilter(v,t,r),h&&(f.type=n.contracts.FilterType.Tuple,f.filterExpressionMetadata=r,F=!0)),F||(m=a.createAdvFilter(v.conditions()[0]),m&&(f.type=powerbi.explore.FilterUtils.getFilterType(m.field,m.supportsCategorical),f.expression=m.field,F=!0)),!F)return[2,null];p.push(f)}return E={filters:p},[4,s.tryGetFilters(E,t)];case 2:return[2,T.sent()]}})})},e.prototype.tryCreateFilterContainer=function(e,t,r){return __awaiter(this,void 0,l,function(){var i;return __generator(this,function(n){switch(n.label){case 0:return[4,this.getParser()];case 1:return i=n.sent(),[4,i.tryCreateFilterContainer(e,t,r)];case 2:return[2,n.sent()]}})})},e.prototype.tryGetFilters=function(e,t){return __awaiter(this,void 0,powerbi.Promise,function(){var r;return __generator(this,function(i){switch(i.label){case 0:return[4,this.getParser()];case 1:return r=i.sent(),[4,r.tryGetFilters(e,t)];case 2:return[2,i.sent()]}})})},e.prototype.tryGetSelectedDataPoints=function(e,t,r,i,n){return __awaiter(this,void 0,powerbi.Promise,function(){var a;return __generator(this,function(o){switch(o.label){case 0:return[4,this.getParser()];case 1:return a=o.sent(),[4,a.tryGetSelectedDataPoints(e,t,r,i,n)];case 2:return[2,o.sent()]}})})},e.prototype.getParser=function(){return __awaiter(this,void 0,powerbi.Promise,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return this.parser?[3,2]:(e=this,[4,s.createJSONFilterParserService(this.promiseFactory,this.moduleLoader,this.telemetryService,this.lazyProviderModern)]);case 1:e.parser=t.sent(),t.label=2;case 2:return[2,this.parser]}})})},e}()});var powerbi;!function(e){var t;!function(t){function r(r,n,o,s,l,u,p,c,d,v,f,F,y,g,h){var m=t.CustomerAction(n,o,s,l,u,p,c,d,v,f,F,y,g,h),E=a(m.info,{filterType:r});return{name:t.JSONFilterUnsupportedFilterTypeEventName,category:e.TelemetryCategory.CustomerAction,time:Date.now(),id:i(),formatted:function(){return e.extendFormatted({filterType:E.filterType},null,m.formatted())},info:E,loggers:t.JSONFilterUnsupportedFilterTypeLoggers}}var i,n=jsCommon.Utility,a=jsCommon.UnionExtensions.mergeUnionType,o=e.telemetry.EventFactories;i=n?n.generateGuid:Function.prototype,t.JSONFilterUnsupportedFilterTypeEventName="PBI.JSONFilter.UnsupportedFilterType",t.JSONFilterUnsupportedFilterType=r,o[t.JSONFilterUnsupportedFilterTypeEventName]=function(r){return e.telemetryEventFactory(t.JSONFilterUnsupportedFilterTypeEventName,r,t.JSONFilterUnsupportedFilterTypeLoggers,t.CustomerActionEventName,e.TelemetryCategory.CustomerAction,void 0,void 0,void 0,null)}}(t=e.telemetry||(e.telemetry={}))}(powerbi||(powerbi={}));